name: Build, Test, and Publish QPdfSharp Libraries

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
    build-test-publish:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup .NET Core
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: '8.x'

        - name: Build Solution
          run: dotnet build ${GITHUB_WORKSPACE}

        - name: Test Solution
          run: dotnet test ${GITHUB_WORKSPACE}

        - name: Version QPdfSharp Library
          id: version-qpdfsharp
          uses: paulhatch/semantic-version@v5.3.0
          with:
            change_path: "src/QPdfSharp"

        - name: Version Interop Library
          id: version-interop
          uses: paulhatch/semantic-version@v5.3.0
          with:
            change_path: "src/QPdfSharp.Interop"
            major_pattern: "(MAJOR-INTEROP)"
            minor_pattern: "(MINOR-INTEROP)"
            namespace: Interop

        - name: Build QPdfSharp Libraries
          env:
            QPDFSHARP_VERSION: ${{ steps.version-qpdfsharp.outputs.version }}
            QPDFSHARP_INTEROP_VERSION: ${{ steps.version-interop.outputs.version }}
          run: "${GITHUB_WORKSPACE}/scripts/build-qpdfsharp-libraries-nuget.sh -p:QPdfSharpVersion=${QPDFSHARP_VERSION} -p:QPdfSharpInteropVersion=${QPDFSHARP_INTEROP_VERSION}"

        - name: Upload NuGet Packages
          uses: actions/upload-artifact@v4
          with:
            if-no-files-found: error
            name: QPdfSharp NuGet Packages
            path: ${GITHUB_WORKSPACE}/artifacts

#        - name: Push NuGet Package
#          run: dotnet nuget push -k ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json ./artifacts/QPdfSharp*.nupkg
