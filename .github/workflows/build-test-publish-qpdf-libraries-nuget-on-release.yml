name: Build, Test, and Publish QPdfSharp Libraries

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
    build-test-publish:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup .NET Core
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: '8.x'

        - name: Build Solution
          run: dotnet build ${GITHUB_WORKSPACE}

        - name: Test Solution
          run: dotnet test ${GITHUB_WORKSPACE}

        - name: Version QPdfSharp Library
          id: version-qpdfsharp
          uses: paulhatch/semantic-version@v5.3.0
          with:
            change_path: "src/QPdfSharp"
            debug: true

        - name: Version Interop Library
          id: version-interop
          uses: paulhatch/semantic-version@v5.3.0
          with:
            change_path: "src/QPdfSharp.Interop"
            debug: true
            major_pattern: "(MAJOR-INTEROP)"
            minor_pattern: "(MINOR-INTEROP)"
            namespace: Interop

        - name: Dump GH Steps  Context
          run: echo "${{ toJson(steps) }}"

        - name: Build QPdfSharp Libraries
          run: "${GITHUB_WORKSPACE}/scripts/build-qpdfsharp-libraries-nuget.sh -p:QPdfSharpVersion=0.3.0 -p:QPdfSharpInteropVersion=1.0.0"

        - name: Verify NuGet Creation
          run: ls -la ./

        - name: Upload NuGet Package
          uses: actions/upload-artifact@v4
          with:
            if-no-files-found: error
            name: QPdfSharp NuGet Packages
            path: ${GITHUB_WORKSPACE}/artifacts

#        - name: Push NuGet Package
#          run: dotnet nuget push -k ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json ./artifacts/QPdfSharp*.nupkg
